name: Test Build And Commit

on:
  workflow_dispatch:  # manually trigger

permissions:
  contents: write

jobs:
  build_sub_flow:
    uses: ./.github/workflows/build.yml
  

  do_release:
    runs-on: ubuntu-latest
    needs: 
      - build_sub_flow
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: dist/

      - name: Verify SHA-256
        run: |
          set -euo pipefail
          cd dist
          shopt -s nullglob
          
          files=( *.sha256 )
          if ((${#files[@]} == 0)); then
            echo "No .sha256 files found under dist/" >&2
            exit 1
          fi
          
          status=0
          for f in "${files[@]}"; do
            if ! sha256sum -c "$f"; then
              status=1
            fi
          done
          exit $status