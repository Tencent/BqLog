name: AutoTest

on:
  workflow_dispatch:  # manually trigger
  workflow_call:
jobs:
  #Windows X86_64
  win64_test_MSVC_cpp14:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MSVC.bat 14
        

  win64_test_MSVC_Clang_cpp14:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_Clang.bat 14
        
  win64_test_MinGW_GCC_cpp14:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'



      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          release: true
          path-type: inherit
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          update: true

      - name: Ensure MSYS2 packages
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm --needed --overwrite '*' mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          echo "MSYS2 Root: $MSYSTEM_CARCH"
          which gcc
          which mingw32-make
      - name: Remove conflicting MinGW paths
        run: |
          $env:Path = $env:Path -replace 'C:\\mingw64\\bin;','' -replace 'C:\\Program Files\\Git\\mingw64\\bin;',''
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell
      - name: Add MSYS2 to PATH
        run: |
          $env:Path = "${{ steps.msys2.outputs.msys2-location }}\mingw64\bin;" + $env:Path
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MinGW_GCC.bat 14
  

  win64_test_MinGW_Clang_cpp14:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MinGW_Clang.bat 14

  win64_test_MSVC_cpp17:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MSVC.bat 17
        

  win64_test_MSVC_Clang_cpp17:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_Clang.bat 17
        
  win64_test_MinGW_GCC_cpp17:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'



      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          release: true
          path-type: inherit
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          update: true

      - name: Ensure MSYS2 packages
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm --needed --overwrite '*' mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          echo "MSYS2 Root: $MSYSTEM_CARCH"
          which gcc
          which mingw32-make
      - name: Remove conflicting MinGW paths
        run: |
          $env:Path = $env:Path -replace 'C:\\mingw64\\bin;','' -replace 'C:\\Program Files\\Git\\mingw64\\bin;',''
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell
      - name: Add MSYS2 to PATH
        run: |
          $env:Path = "${{ steps.msys2.outputs.msys2-location }}\mingw64\bin;" + $env:Path
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MinGW_GCC.bat 17
  

  win64_test_MinGW_Clang_cpp17:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MinGW_Clang.bat 17

  win64_test_MSVC_cpp20:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MSVC.bat 20

  win64_test_MSVC_Clang_cpp20:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_Clang.bat 20
        
  win64_test_MinGW_GCC_cpp20:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          release: true
          path-type: inherit
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          update: true

      - name: Ensure MSYS2 packages
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm --needed --overwrite '*' mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          echo "MSYS2 Root: $MSYSTEM_CARCH"
          which gcc
          which mingw32-make
      - name: Remove conflicting MinGW paths
        run: |
          $env:Path = $env:Path -replace 'C:\\mingw64\\bin;','' -replace 'C:\\Program Files\\Git\\mingw64\\bin;',''
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell
      - name: Add MSYS2 to PATH
        run: |
          $env:Path = "${{ steps.msys2.outputs.msys2-location }}\mingw64\bin;" + $env:Path
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MinGW_GCC.bat 20

  win64_test_MinGW_Clang_cpp20:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MinGW_Clang.bat 20

  win64_test_MSVC_cpp23:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MSVC.bat 23
        

  win64_test_MSVC_Clang_cpp23:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_Clang.bat 23

  win64_test_MinGW_GCC_cpp23:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          release: true
          path-type: inherit
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          update: true

      - name: Ensure MSYS2 packages
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm --needed --overwrite '*' mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          echo "MSYS2 Root: $MSYSTEM_CARCH"
          which gcc
          which mingw32-make
      - name: Remove conflicting MinGW paths
        run: |
          $env:Path = $env:Path -replace 'C:\\mingw64\\bin;','' -replace 'C:\\Program Files\\Git\\mingw64\\bin;',''
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell
      - name: Add MSYS2 to PATH
        run: |
          $env:Path = "${{ steps.msys2.outputs.msys2-location }}\mingw64\bin;" + $env:Path
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MinGW_GCC.bat 23
  

  win64_test_MinGW_Clang_cpp23:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\RunTest_MinGW_Clang.bat 23      

  #Windows ARM64
  win_arm64_test_MinGW_Clang_cpp14:
    runs-on: windows-11-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Install Clang
        run: |
          choco uninstall -y llvm --all-versions
          choco install -y llvm
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          mkdir build_folder
          cd build_folder
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=14 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make
          objdump -f BqLogUnitTest.exe
          .\BqLogUnitTest.exe
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=14 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make -j4
          .\BqLogUnitTest.exe

  win_arm64_test_MinGW_Clang_cpp17:
    runs-on: windows-11-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Clang
        run: |
          choco uninstall -y llvm --all-versions
          choco install -y llvm
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          mkdir build_folder
          cd build_folder
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=17 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make
          objdump -f BqLogUnitTest.exe
          .\BqLogUnitTest.exe
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=17 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make -j4
          .\BqLogUnitTest.exe

  win_arm64_test_MinGW_Clang_cpp20:
    runs-on: windows-11-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Clang
        run: |
          choco uninstall -y llvm --all-versions
          choco install -y llvm
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          mkdir build_folder
          cd build_folder
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=20 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make
          objdump -f BqLogUnitTest.exe
          .\BqLogUnitTest.exe
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=20 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make -j4
          .\BqLogUnitTest.exe


  #Linux-ubuntu-X86_64
  ubuntu_test_GCC_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 11
  
  ubuntu_test_Clang_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 11

  ubuntu_test_GCC_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 14

  ubuntu_test_Clang_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 14

  ubuntu_test_GCC_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 17

  ubuntu_test_Clang_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 17

  ubuntu_test_GCC_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 20

  ubuntu_test_Clang_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 20

  ubuntu_test_GCC_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 23

  ubuntu_test_Clang_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 23
          
  #Linux-ubuntu-ARM64
  ubuntu_arm64_test_GCC_cpp11:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 11

  ubuntu_arm64_test_Clang_cpp11:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 11

  ubuntu_arm64_test_GCC_cpp14:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 14

  ubuntu_arm64_test_Clang_cpp14:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 14

  ubuntu_arm64_test_GCC_cpp17:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 17

  ubuntu_arm64_test_Clang_cpp17:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 17

  ubuntu_arm64_test_GCC_cpp20:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 20

  ubuntu_arm64_test_Clang_cpp20:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 20

  ubuntu_arm64_test_GCC_cpp23:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_GCC.sh 23

  ubuntu_arm64_test_Clang_cpp23:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./RunTest_Clang.sh 23

  #linux-debian
  debian_test_GCC_cpp17:
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/pippocao/bqlog/debian:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install necessary tools (gcc and clang)
        run: |
          apt-get update
          apt-get install -y gcc clang g++ make cmake

          apt-get install -y software-properties-common
          apt-get update
          apt-get install -y openjdk-17-jdk

      - name: Set up Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV

      - name: Build for Debian
        run: |
            cd build/test/linux  
            chmod +x *.sh
            ./RunTest_GCC.sh 
  
  debian_test_Clang_cpp17:
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/pippocao/bqlog/debian:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install necessary tools (gcc and clang)
        run: |
          apt-get update
          apt-get install -y gcc clang g++ make cmake

          apt-get install -y software-properties-common
          apt-get update
          apt-get install -y openjdk-17-jdk

      - name: Set up Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV

      - name: Build for Debian
        run: |
            cd build/test/linux  
            chmod +x *.sh
            ./RunTest_Clang.sh 

  debian32_test_GCC_cpp17:
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/pippocao/bqlog/i386_debian:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386" >> $GITHUB_ENV

      - name: Build for Debian 32
        run: |
            cd build/test/linux  
            chmod +x *.sh
            ./RunTest_GCC.sh 

  debian32_test_Clang_cpp17:
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/pippocao/bqlog/i386_debian:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386" >> $GITHUB_ENV

      - name: Build for Debian 32
        run: |
            cd build/test/linux  
            chmod +x *.sh
            ./RunTest_Clang.sh 

  #Mac
  mac_apple_silicon_test_cpp11:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Set up XCode
        run: sudo xcode-select --switch /Applications/Xcode.app

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./RunTest.sh 11

  mac_apple_silicon_test_cpp14:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Set up XCode
        run: sudo xcode-select --switch /Applications/Xcode.app

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./RunTest.sh 14

  mac_apple_silicon_test_cpp17:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Set up XCode
        run: sudo xcode-select --switch /Applications/Xcode.app

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./RunTest.sh 17

  mac_apple_silicon_test_cpp20:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Set up XCode
        run: sudo xcode-select --switch /Applications/Xcode.app

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./RunTest.sh 20

  mac_apple_silicon_test_cpp23:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Set up XCode
        run: sudo xcode-select --switch /Applications/Xcode.app

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./RunTest.sh 23

  #Unix-FreeBSD
  #Unix-FreeBSD AMD64 GCC
  freeBSD_test_GCC_cpp17:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/pippocao/bqlog/freebsd_amd64:latest
      options: --privileged  # Required for running QEMU inside container
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start FreeBSD VM and run tests
        run: |
          # Create SSH directory with proper permissions
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Create test script for FreeBSD
          cat > /tmp/freebsd_test.sh << 'EOF'
          #!/bin/sh
          set -e
          
          # Install required packages
          pkg update -f
          pkg install -y gcc cmake bash openjdk11
          
          # Setup Java environment
          export JAVA_HOME="/usr/local/openjdk11"
          export PATH="$JAVA_HOME/bin:$PATH"
          
          # Run tests
          cd /root/workspace/build/test/unix_like
          chmod +x *.sh
          ./RunTest_GCC.sh
          
          # Return exit code
          exit $?
          EOF
          
          # List available FreeBSD images
          echo "Available FreeBSD images:"
          ls -la /freebsd/
          
          # Start FreeBSD VM with QEMU - use display none instead of nographic
          qemu-system-x86_64 -m 16G -smp 2 -display none -serial null \
            -device virtio-net,netdev=net0 \
            -netdev user,id=net0,hostfwd=tcp::2222-:22 \
            -drive file=/freebsd/FreeBSD-14.2-RELEASE-amd64.qcow2,if=virtio \
            -daemonize
          
          # Generate SSH key
          ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
          
          # Wait for VM to boot with robust retry logic
          echo "Waiting for FreeBSD VM to boot..."
          MAX_ATTEMPTS=30
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS"
            if nc -z -w 5 localhost 2222; then
              echo "VM is up!"
              break
            fi
          
            if [ $i -eq $MAX_ATTEMPTS ]; then
              echo "Failed to connect to VM after $MAX_ATTEMPTS attempts"
              exit 1
            fi
          
            sleep 10
          done
          
          ssh-keyscan -p 2222 localhost >> ~/.ssh/known_hosts
          
          # Copy test script to VM
          scp -P 2222 -o StrictHostKeyChecking=no /tmp/freebsd_test.sh root@localhost:/root/
          ssh -p 2222 -o StrictHostKeyChecking=no root@localhost "chmod +x /root/freebsd_test.sh"
          
          # Copy workspace to VM
          scp -P 2222 -r $GITHUB_WORKSPACE root@localhost:/root/workspace
          
          # Run test and capture exit code
          ssh -p 2222 -o StrictHostKeyChecking=no root@localhost "/root/freebsd_test.sh"
          EXIT_CODE=$?
          
          echo "Test completed with exit code: $EXIT_CODE"
          exit $EXIT_CODE

  #Unix-FreeBSD AMD64 Clang
  freeBSD_test_Clang_cpp17:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/pippocao/bqlog/freebsd_amd64:latest
      options: --privileged  # Required for running QEMU inside container
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start FreeBSD VM and run tests
        run: |
          # Create SSH directory with proper permissions
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Create test script for FreeBSD
          cat > /tmp/freebsd_test.sh << 'EOF'
          #!/bin/sh
          set -e
          
          # Install required packages
          pkg update -f
          pkg install -y gcc cmake bash openjdk11
          
          # Setup Java environment
          export JAVA_HOME="/usr/local/openjdk11"
          export PATH="$JAVA_HOME/bin:$PATH"
          
          # Run tests
          cd /root/workspace/build/test/unix_like
          chmod +x *.sh
          ./RunTest_Clang.sh
          
          # Return exit code
          exit $?
          EOF
          
          # List available FreeBSD images
          echo "Available FreeBSD images:"
          ls -la /freebsd/
          
          # Start FreeBSD VM with QEMU - use display none instead of nographic
          qemu-system-x86_64 -m 16G -smp 2 -display none -serial null \
            -device virtio-net,netdev=net0 \
            -netdev user,id=net0,hostfwd=tcp::2222-:22 \
            -drive file=/freebsd/FreeBSD-14.2-RELEASE-amd64.qcow2,if=virtio \
            -daemonize
          
          # Generate SSH key
          ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
          
          # Wait for VM to boot with robust retry logic
          echo "Waiting for FreeBSD VM to boot..."
          MAX_ATTEMPTS=30
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS"
            if nc -z -w 5 localhost 2222; then
              echo "VM is up!"
              break
            fi
          
            if [ $i -eq $MAX_ATTEMPTS ]; then
              echo "Failed to connect to VM after $MAX_ATTEMPTS attempts"
              exit 1
            fi
          
            sleep 10
          done
          
          ssh-keyscan -p 2222 localhost >> ~/.ssh/known_hosts
          
          # Copy test script to VM
          scp -P 2222 -o StrictHostKeyChecking=no /tmp/freebsd_test.sh root@localhost:/root/
          ssh -p 2222 -o StrictHostKeyChecking=no root@localhost "chmod +x /root/freebsd_test.sh"
          
          # Copy workspace to VM
          scp -P 2222 -r $GITHUB_WORKSPACE root@localhost:/root/workspace
          
          # Run test and capture exit code
          ssh -p 2222 -o StrictHostKeyChecking=no root@localhost "/root/freebsd_test.sh"
          EXIT_CODE=$?
          
          echo "Test completed with exit code: $EXIT_CODE"
          exit $EXIT_CODE

  #Unix-FreeBSD ARM64 GCC
  freeBSD_arm64_test_GCC_cpp17:
    runs-on: ubuntu-24.04-arm
    container:
      image: ghcr.io/pippocao/bqlog/freebsd_arm64:latest
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test script
        run: |
          mkdir -p /tmp/shared
          # 创建测试脚本
          cat > /tmp/shared/run_tests.sh << 'EOF'
          #!/bin/sh
          # 安装所需软件包
          pkg update -f
          pkg install -y gcc cmake bash openjdk11

          # 设置Java环境
          export JAVA_HOME="/usr/local/openjdk11" 
          export PATH="$JAVA_HOME/bin:$PATH"

          # 运行测试
          cd /github/workspace/build/test/unix_like
          chmod +x *.sh
          ./RunTest_GCC.sh

          # 保存退出代码
          echo $? > /tmp/exit_code
          EOF
          chmod +x /tmp/shared/run_tests.sh

          # 复制GitHub工作区到共享目录
          cp -r $GITHUB_WORKSPACE /tmp/shared/workspace

      - name: Run FreeBSD ARM64 tests
        run: |
          # 启动FreeBSD VM并等待完成
          # 使用expect自动化控制台交互
          apt-get update && apt-get install -y expect

          # 创建expect脚本
          cat > /tmp/freebsd_test.exp << 'EOF'
          #!/usr/bin/expect

          set timeout 1800
          spawn qemu-system-aarch64 -m 16G -smp 2 -M virt -cpu cortex-a57 -nographic \
            -drive file=/freebsd/FreeBSD-14.2-RELEASE-arm64-aarch64.qcow2,if=none,id=drive0 \
            -device virtio-blk-pci,drive=drive0 \
            -virtfs local,path=/tmp/shared,mount_tag=host0,security_model=none,id=host0

          # 等待登录提示
          expect "login:" { send "root\r" }
          expect "Password:" { send "root\r" }  # 假定默认密码是root

          # 挂载共享目录并运行测试
          expect "# " { send "mkdir -p /github\r" }
          expect "# " { send "mount_9p host0 /github\r" }
          expect "# " { send "mkdir -p /github/workspace\r" }
          expect "# " { send "cp -r /github/shared/workspace/* /github/workspace/\r" }
          expect "# " { send "sh /github/shared/run_tests.sh\r" }

          # 等待测试完成并获取退出代码
          expect "# " { send "cat /tmp/exit_code\r" }
          expect "# " { send "shutdown -p now\r" }

          # 等待关机
          expect eof
          EOF

          chmod +x /tmp/freebsd_test.exp
          /tmp/freebsd_test.exp | tee /tmp/test_output.log

          # 从输出日志中提取退出代码
          EXIT_CODE=$(grep -A 1 "cat /tmp/exit_code" /tmp/test_output.log | tail -1 | tr -d '\r\n')
          echo "Test completed with exit code: $EXIT_CODE"
          exit $EXIT_CODE

  #Unix-FreeBSD ARM64 Clang
  freeBSD_arm64_test_Clang_cpp17:
    runs-on: ubuntu-24.04-arm
    container:
      image: ghcr.io/pippocao/bqlog/freebsd_arm64:latest
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start FreeBSD VM and run tests
        run: |
          # Create SSH directory with proper permissions
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Create test script for FreeBSD
          cat > /tmp/freebsd_test.sh << 'EOF'
          #!/bin/sh
          set -e
          
          # Install required packages
          pkg update -f
          pkg install -y gcc cmake bash openjdk11
          
          # Setup Java environment
          export JAVA_HOME="/usr/local/openjdk11"
          export PATH="$JAVA_HOME/bin:$PATH"
          
          # Run tests
          cd /root/workspace/build/test/unix_like
          chmod +x *.sh
          ./RunTest_Clang.sh
          
          # Return exit code
          exit $?
          EOF
          
          # List available FreeBSD images
          echo "Available FreeBSD images:"
          ls -la /freebsd/
          
          # Start FreeBSD ARM64 VM with QEMU - use display none instead of nographic
          qemu-system-aarch64 -m 16G -smp 2 -M virt -cpu cortex-a57 -display none -serial null \
            -device virtio-net-pci,netdev=net0 \
            -netdev user,id=net0,hostfwd=tcp::2222-:22 \
            -drive file=/freebsd/FreeBSD-14.2-RELEASE-arm64-aarch64.qcow2,if=none,id=drive0 \
            -device virtio-blk-pci,drive=drive0 \
            -daemonize
          
          # Generate SSH key
          ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
          
          # Wait for VM to boot with robust retry logic
          echo "Waiting for FreeBSD ARM64 VM to boot..."
          MAX_ATTEMPTS=40  # More attempts for ARM
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS"
            if nc -z -w 5 localhost 2222; then
              echo "VM is up!"
              break
            fi
          
            if [ $i -eq $MAX_ATTEMPTS ]; then
              echo "Failed to connect to VM after $MAX_ATTEMPTS attempts"
              exit 1
            fi
          
            sleep 10
          done
          
          ssh-keyscan -p 2222 localhost >> ~/.ssh/known_hosts
          
          # Copy test script to VM
          scp -P 2222 -o StrictHostKeyChecking=no /tmp/freebsd_test.sh root@localhost:/root/
          ssh -p 2222 -o StrictHostKeyChecking=no root@localhost "chmod +x /root/freebsd_test.sh"
          
          # Copy workspace to VM
          scp -P 2222 -r $GITHUB_WORKSPACE root@localhost:/root/workspace
          
          # Run test and capture exit code
          ssh -p 2222 -o StrictHostKeyChecking=no root@localhost "/root/freebsd_test.sh"
          EXIT_CODE=$?
          
          echo "Test completed with exit code: $EXIT_CODE"
          exit $EXIT_CODE