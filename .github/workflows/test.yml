name: AutoTest

on:
  workflow_dispatch:  # manually trigger
    inputs:
      run_arm_tests:
        description: 'Run slow ARM test jobs'
        required: false
        type: boolean
        default: false
  workflow_call:
jobs:
  #Windows X86_64
  win64_x86_64_testMSVC_cpp14:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_msvc.bat 14
  

  win64_x86_64_testMSVC_Clang_cpp14:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_clang.bat 14

  win64_x86_64_testMinGW_GCC_cpp14:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'



      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          release: true
          path-type: inherit
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          update: true

      - name: Ensure MSYS2 packages
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm --needed --overwrite '*' mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          echo "MSYS2 Root: $MSYSTEM_CARCH"
          which gcc
          which mingw32-make
      - name: Remove conflicting MinGW paths
        run: |
          $env:Path = $env:Path -replace 'C:\\mingw64\\bin;','' -replace 'C:\\Program Files\\Git\\mingw64\\bin;',''
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell
      - name: Add MSYS2 to PATH
        run: |
          $env:Path = "${{ steps.msys2.outputs.msys2-location }}\mingw64\bin;" + $env:Path
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_MinGW_GCC.bat 14
  

  win64_x86_64_testMinGW_Clang_cpp14:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_MinGW_Clang.bat 14

  win64_x86_64_testMSVC_cpp17:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_msvc.bat 17
  

  win64_x86_64_testMSVC_Clang_cpp17:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_clang.bat 17

  win64_x86_64_testMinGW_GCC_cpp17:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'



      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          release: true
          path-type: inherit
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          update: true

      - name: Ensure MSYS2 packages
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm --needed --overwrite '*' mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          echo "MSYS2 Root: $MSYSTEM_CARCH"
          which gcc
          which mingw32-make
      - name: Remove conflicting MinGW paths
        run: |
          $env:Path = $env:Path -replace 'C:\\mingw64\\bin;','' -replace 'C:\\Program Files\\Git\\mingw64\\bin;',''
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell
      - name: Add MSYS2 to PATH
        run: |
          $env:Path = "${{ steps.msys2.outputs.msys2-location }}\mingw64\bin;" + $env:Path
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_MinGW_GCC.bat 17
  

  win64_x86_64_testMinGW_Clang_cpp17:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_MinGW_Clang.bat 17

  win64_x86_64_testMSVC_cpp20:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_msvc.bat 20

  win64_x86_64_testMSVC_Clang_cpp20:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_clang.bat 20

  win64_x86_64_testMinGW_GCC_cpp20:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          release: true
          path-type: inherit
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          update: true

      - name: Ensure MSYS2 packages
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm --needed --overwrite '*' mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          echo "MSYS2 Root: $MSYSTEM_CARCH"
          which gcc
          which mingw32-make
      - name: Remove conflicting MinGW paths
        run: |
          $env:Path = $env:Path -replace 'C:\\mingw64\\bin;','' -replace 'C:\\Program Files\\Git\\mingw64\\bin;',''
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell
      - name: Add MSYS2 to PATH
        run: |
          $env:Path = "${{ steps.msys2.outputs.msys2-location }}\mingw64\bin;" + $env:Path
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_MinGW_GCC.bat 20

  win64_x86_64_testMinGW_Clang_cpp20:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_MinGW_Clang.bat 20

  win64_x86_64_testMSVC_cpp23:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_msvc.bat 23
  

  win64_x86_64_testMSVC_Clang_cpp23:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_clang.bat 23

  win64_x86_64_testMinGW_GCC_cpp23:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          release: true
          path-type: inherit
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          update: true

      - name: Ensure MSYS2 packages
        shell: msys2 {0}
        run: |
          pacman -S --noconfirm --needed --overwrite '*' mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils mingw-w64-x86_64-make
          echo "MSYS2 Root: $MSYSTEM_CARCH"
          which gcc
          which mingw32-make
      - name: Remove conflicting MinGW paths
        run: |
          $env:Path = $env:Path -replace 'C:\\mingw64\\bin;','' -replace 'C:\\Program Files\\Git\\mingw64\\bin;',''
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell
      - name: Add MSYS2 to PATH
        run: |
          $env:Path = "${{ steps.msys2.outputs.msys2-location }}\mingw64\bin;" + $env:Path
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_MinGW_GCC.bat 23
  

  win64_x86_64_testMinGW_Clang_cpp23:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for Windows
        run: |
          cd build\test\win64  
          .\run_test_MinGW_Clang.bat 23      

  #Windows ARM64
  win_arm64_test_MinGW_Clang_cpp14:
    runs-on: windows-11-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Clang
        run: |
          choco uninstall -y llvm --all-versions
          choco install -y llvm
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          mkdir build_folder
          cd build_folder
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=14 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make
          objdump -f BqLogUnitTest.exe
          .\BqLogUnitTest.exe
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=14 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make -j4
          .\BqLogUnitTest.exe

  win_arm64_test_MinGW_Clang_cpp17:
    runs-on: windows-11-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Clang
        run: |
          choco uninstall -y llvm --all-versions
          choco install -y llvm
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          mkdir build_folder
          cd build_folder
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=17 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make
          objdump -f BqLogUnitTest.exe
          .\BqLogUnitTest.exe
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=17 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make -j4
          .\BqLogUnitTest.exe

  win_arm64_test_MinGW_Clang_cpp20:
    runs-on: windows-11-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Clang
        run: |
          choco uninstall -y llvm --all-versions
          choco install -y llvm
        shell: powershell

      - name: Build for Windows
        run: |
          cd build\test\win64  
          mkdir build_folder
          cd build_folder
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=20 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make
          objdump -f BqLogUnitTest.exe
          .\BqLogUnitTest.exe
          cmake ..\..\..\..\test -G "MinGW Makefiles" -DTARGET_PLATFORM:STRING=win64 -DCPP_VER=20 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          make -j4
          .\BqLogUnitTest.exe


  #Linux-ubuntu-X86_64
  ubuntu_x86_64_testGCC_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 11
  
  ubuntu_x86_64_testClang_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 11

  ubuntu_x86_64_testGCC_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 14

  ubuntu_x86_64_testClang_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 14

  ubuntu_x86_64_testGCC_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 17

  ubuntu_x86_64_testClang_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 17

  ubuntu_x86_64_testGCC_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 20

  ubuntu_x86_64_testClang_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 20

  ubuntu_x86_64_testGCC_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 23

  ubuntu_x86_64_testClang_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 23

  #Linux-ubuntu-ARM64
  ubuntu_arm64_test_GCC_cpp11:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 11

  ubuntu_arm64_test_Clang_cpp11:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 11

  ubuntu_arm64_test_GCC_cpp14:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 14

  ubuntu_arm64_test_Clang_cpp14:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 14

  ubuntu_arm64_test_GCC_cpp17:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 17

  ubuntu_arm64_test_Clang_cpp17:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 17

  ubuntu_arm64_test_GCC_cpp20:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 20

  ubuntu_arm64_test_Clang_cpp20:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 20

  ubuntu_arm64_test_GCC_cpp23:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 23

  ubuntu_arm64_test_Clang_cpp23:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install GDB
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb

      - name: Build for Linux
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 23

  #linux-debian
  debian_x86_64_test_GCC_cpp17:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/pippocao/bqlog/debian:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install necessary tools (gcc and clang)
        run: |
          apt-get update
          apt-get install -y gcc clang g++ make cmake gdb

          apt-get install -y software-properties-common
          apt-get update
          apt-get install -y openjdk-17-jdk
          apt-get install -y openssh-client

      - name: Set up Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV

      - name: Build for Debian
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 
  
  debian_x86_64_test_Clang_cpp17:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/pippocao/bqlog/debian:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install necessary tools (gcc and clang)
        run: |
          apt-get update
          apt-get install -y gcc clang g++ make cmake gdb

          apt-get install -y software-properties-common
          apt-get update
          apt-get install -y openjdk-17-jdk
          apt-get install -y openssh-client

      - name: Set up Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV

      - name: Build for Debian
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 

  debian_x86_test_GCC_cpp17:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/pippocao/bqlog/i386_debian:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install necessary tools (gcc and clang)
        run: |
          apt-get update
          apt-get install -y gcc clang g++ make cmake gdb

          apt-get install -y software-properties-common
          apt-get update
          apt-get install -y openjdk-17-jdk
          apt-get install -y openssh-client

      - name: Set up Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386" >> $GITHUB_ENV

      - name: Build for Debian 32
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 

  debian_x86_test_Clang_cpp17:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/pippocao/bqlog/i386_debian:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install necessary tools (gcc and clang)
        run: |
          apt-get update
          apt-get install -y gcc clang g++ make cmake gdb

          apt-get install -y software-properties-common
          apt-get update
          apt-get install -y openjdk-17-jdk
          apt-get install -y openssh-client

      - name: Set up Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-i386" >> $GITHUB_ENV

      - name: Build for Debian 32
        run: |
          cd build/test/linux  
          chmod +x *.sh
          ./run_test_clang.sh 

  #Mac
  mac_apple_silicon_test_cpp11:
    runs-on: macos-latest
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./run_test.sh 11

  mac_apple_silicon_test_cpp14:
    runs-on: macos-latest
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./run_test.sh 14

  mac_apple_silicon_test_cpp17:
    runs-on: macos-latest
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./run_test.sh 17

  mac_apple_silicon_test_cpp20:
    runs-on: macos-latest
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./run_test.sh 20

  mac_apple_silicon_test_cpp23:
    runs-on: macos-latest
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build for macOS
        run: |
          cd build/test/mac  
          chmod +x *.sh
          ./run_test.sh 23

  #Unix-FreeBSD
  freeBSD_x86_64_test_Clang_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 11

  freeBSD_x86_64_test_GCC_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 11
            
  freeBSD_x86_64_test_Clang_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 17

  freeBSD_x86_64_test_GCC_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 17
            
  freeBSD_x86_64_test_Clang_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 20

  freeBSD_x86_64_test_GCC_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 20
            
  freeBSD_x86_64_test_Clang_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 23

  freeBSD_x86_64_test_GCC_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 23
  
  freeBSD_arm64_test_Clang_cpp17:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            set +e
            ./run_test_clang.sh 17
            EXIT_CODE=$?
            set -e
            if [ $EXIT_CODE -ne 0 ]; then
              echo "Test failed with exit code $EXIT_CODE"
              CORE_FILE="$(find . -maxdepth 5 -type f \( -name 'core' -o -name 'core.*' -o -name '*.core' \) 2>/dev/null | head -n1)"
              EXE=""
              for cand in ./BqLogUnitTest ./BqLogUnitTest.exe $(find . -maxdepth 5 -type f -name 'BqLogUnitTest' 2>/dev/null | head -n1); do
                if [ -n "$cand" ] && [ -x "$cand" ]; then EXE="$cand"; break; fi
              done
              echo "exe: ${EXE:-<not found>}"
              echo "core: ${CORE_FILE:-<not found>}"
              if [ -n "$CORE_FILE" ] && [ -n "$EXE" ]; then
                echo "=== GDB core backtrace (FreeBSD aarch64) ==="
                gdb --batch -q \
                  -ex "set pagination off" \
                  -ex "info threads" \
                  -ex "thread apply all bt full" \
                  -ex "quit" \
                  "$EXE" "$CORE_FILE" || echo "gdb analysis failed"
              else
                echo "Core file or executable not found, listing candidates:"
                find . -maxdepth 5 -type f \( -name 'core' -o -name 'core.*' -o -name '*.core' -o -name 'BqLogUnitTest' \) 2>/dev/null || true
              fi
              exit $EXIT_CODE
            fi


  freeBSD_arm64_test_GCC_cpp17:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in FreeBSD
        id: RunInFreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y llvm cmake bash gdb gcc13

          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ln -sf /usr/local/bin/gcc13 /usr/local/bin/gcc
            ln -sf /usr/local/bin/g++13 /usr/local/bin/g++
            ln -sf /usr/local/bin/gcov13 /usr/local/bin/gcov 2>/dev/null || true
            ln -sf /usr/local/bin/gcc-ar13 /usr/local/bin/gcc-ar 2>/dev/null || true
            ln -sf /usr/local/bin/gcc-ranlib13 /usr/local/bin/gcc-ranlib 2>/dev/null || true
            export LD_LIBRARY_PATH=/usr/local/lib/gcc13  #Adjust according to installed GCC version
            ./run_test_gcc.sh 17
  

  #Unix-Solaris
  solaris_x86_64_test_GCC_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in Solaris
        id: RunInSolaris
        uses: vmactions/solaris-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg publisher
            pkg install -v --accept \
              developer/build/cmake \
              developer/build/gnu-make \
              developer/debug/gdb \
              developer/gcc-14 \
              shell/bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 11 

  solaris_x86_64_test_GCC_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in Solaris
        id: RunInSolaris
        uses: vmactions/solaris-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg publisher
            pkg install -v --accept \
              developer/build/cmake \
              developer/build/gnu-make \
              developer/debug/gdb \
              developer/gcc-14 \
              shell/bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 14

  solaris_x86_64_test_GCC_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in Solaris
        id: RunInSolaris
        uses: vmactions/solaris-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg publisher
            pkg install -v --accept \
              developer/build/cmake \
              developer/build/gnu-make \
              developer/debug/gdb \
              developer/gcc-14 \
              shell/bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 17

  solaris_x86_64_test_GCC_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in Solaris
        id: RunInSolaris
        uses: vmactions/solaris-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg publisher
            pkg install -v --accept \
              developer/build/cmake \
              developer/build/gnu-make \
              developer/debug/gdb \
              developer/gcc-14 \
              shell/bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 20

  solaris_x86_64_test_GCC_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in Solaris
        id: RunInSolaris
        uses: vmactions/solaris-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg publisher
            pkg install -v --accept \
              developer/build/cmake \
              developer/build/gnu-make \
              developer/debug/gdb \
              developer/gcc-14 \
              shell/bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 23 

  #Unix-OmnisOS
  omnisOS_x86_64_test_GCC_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OmnisOS
        id: RunInOmnisOS
        uses: vmactions/omnios-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            set -e
            pkg refresh --full
            if ! pkg publisher | grep -q '^extra\.omnios'; then
              REL="$(uname -v | sed -n 's/.*\(r[0-9][0-9]*\).*/\1/p')"
              [ -n "$REL" ] || REL="r151054"
              pkg set-publisher -g "https://pkg.omnios.org/${REL}/extra" extra.omnios || true
              pkg refresh --full
            fi
            
            pkg install -v --accept shell/bash developer/build/gnu-make || true
            pkg install -v --accept ooce/developer/cmake
            pkg install -v --accept developer/gcc13
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 11 

  omnisOS_x86_64_test_GCC_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OmnisOS
        id: RunInOmnisOS
        uses: vmactions/omnios-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            set -e
            pkg refresh --full
            if ! pkg publisher | grep -q '^extra\.omnios'; then
              REL="$(uname -v | sed -n 's/.*\(r[0-9][0-9]*\).*/\1/p')"
              [ -n "$REL" ] || REL="r151054"
              pkg set-publisher -g "https://pkg.omnios.org/${REL}/extra" extra.omnios || true
              pkg refresh --full
            fi
            
            pkg install -v --accept shell/bash developer/build/gnu-make || true
            pkg install -v --accept ooce/developer/cmake
            pkg install -v --accept developer/gcc13
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 14 

  omnisOS_x86_64_test_GCC_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OmnisOS
        id: RunInOmnisOS
        uses: vmactions/omnios-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            set -e
            pkg refresh --full
            if ! pkg publisher | grep -q '^extra\.omnios'; then
              REL="$(uname -v | sed -n 's/.*\(r[0-9][0-9]*\).*/\1/p')"
              [ -n "$REL" ] || REL="r151054"
              pkg set-publisher -g "https://pkg.omnios.org/${REL}/extra" extra.omnios || true
              pkg refresh --full
            fi
            
            pkg install -v --accept shell/bash developer/build/gnu-make || true
            pkg install -v --accept ooce/developer/cmake
            pkg install -v --accept developer/gcc13
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 17 

  omnisOS_x86_64_test_GCC_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OmnisOS
        id: RunInOmnisOS
        uses: vmactions/omnios-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            set -e
            pkg refresh --full
            if ! pkg publisher | grep -q '^extra\.omnios'; then
              REL="$(uname -v | sed -n 's/.*\(r[0-9][0-9]*\).*/\1/p')"
              [ -n "$REL" ] || REL="r151054"
              pkg set-publisher -g "https://pkg.omnios.org/${REL}/extra" extra.omnios || true
              pkg refresh --full
            fi
            
            pkg install -v --accept shell/bash developer/build/gnu-make || true
            pkg install -v --accept ooce/developer/cmake
            pkg install -v --accept developer/gcc13
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 20 
            
  omnisOS_x86_64_test_GCC_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OmnisOS
        id: RunInOmnisOS
        uses: vmactions/omnios-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            set -e
            pkg refresh --full
            if ! pkg publisher | grep -q '^extra\.omnios'; then
              REL="$(uname -v | sed -n 's/.*\(r[0-9][0-9]*\).*/\1/p')"
              [ -n "$REL" ] || REL="r151054"
              pkg set-publisher -g "https://pkg.omnios.org/${REL}/extra" extra.omnios || true
              pkg refresh --full
            fi
            
            pkg install -v --accept shell/bash developer/build/gnu-make || true
            pkg install -v --accept ooce/developer/cmake
            pkg install -v --accept developer/gcc13
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 23 

  #Unix-DragonFlyBSD
  dragonflyBSD_x86_64_test_Clang_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 11 

  dragonflyBSD_x86_64_test_GCC_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 11 

  dragonflyBSD_x86_64_test_Clang_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 14

  dragonflyBSD_x86_64_test_GCC_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 14

  dragonflyBSD_x86_64_test_Clang_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 17

  dragonflyBSD_x86_64_test_GCC_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 17 

  dragonflyBSD_x86_64_test_Clang_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 20

  dragonflyBSD_x86_64_test_GCC_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_gcc.sh 20

  dragonflyBSD_x86_64_test_Clang_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in DragonFlyBSD
        id: DragonFlyBSD
        uses: vmactions/dragonflybsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg install -y cmake bash gmake gdb openjdk11 gcc llvm
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ./run_test_clang.sh 23
            
  #Unix-OpenBSD
  openBSD_x86_64_test_Clang_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            set -x
            export PKG_PATH="http://cdn.openbsd.org/pub/OpenBSD/$(uname -r)/packages/$(arch -s)/"
            pkg_add -v -I cmake bash gdb

            # --- Prepare step diagnostics ---
            echo "--- GDB installation diagnostics ---"
            echo "PATH=$PATH"
            pkg_info | grep gdb
            ls -l /usr/local/bin/gdb* /usr/bin/gdb*
            echo "--- End of diagnostics ---"

          run: |
            set -e -x
            ulimit -c unlimited || true
            sysctl kern.coredump=1 || true
            sysctl kern.corefile=core.%p 2>/dev/null || sysctl kern.corefile=core || true

            cd build/test/unix_like
            chmod +x *.sh

            GDB_CMD=""
            if [ -x "/usr/local/bin/gdb" ]; then
              GDB_CMD="/usr/local/bin/gdb"
            elif [ -x "/usr/local/bin/egdb" ]; then
              GDB_CMD="/usr/local/bin/egdb"
            elif [ -x "/usr/bin/gdb" ]; then
              GDB_CMD="/usr/bin/gdb"
            fi

            if [ -n "$GDB_CMD" ]; then
              echo "Found GDB at: $GDB_CMD"
              if ! $GDB_CMD --version | grep "GNU gdb"; then
                echo "!!! Command '$GDB_CMD' is not a valid GNU gdb. Aborting."
                exit 1
              fi
            else
              echo "!!! GNU gdb not found. Aborting."
              exit 1
            fi

            set +e
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 11
            EXIT_CODE=$?
            set -e

            if [ $EXIT_CODE -ne 0 ]; then
              echo "Test failed with exit $EXIT_CODE. Searching for core..."
              CORE_FILE="$(find . -maxdepth 5 -type f \( -name 'core' -o -name 'core.*' -o -name '*.core' \) 2>/dev/null | head -n1)"

              EXE=""
              for cand in ./BqLogUnitTest ./CMakeFiles/BqLogUnitTest $(find . -maxdepth 5 -type f -name 'BqLogUnitTest' 2>/dev/null | head -n1); do
                if [ -n "$cand" ] && [ -x "$cand" ]; then EXE="$cand"; break; fi
              done

              echo "exe: ${EXE:-<not found>}"
              echo "core: ${CORE_FILE:-<not found>}"

              if [ -n "$CORE_FILE" ] && [ -n "$EXE" ]; then
                echo "=== GDB core backtrace ==="
                $GDB_CMD --batch -q \
                  -ex "set pagination off" \
                  -ex "info threads" \
                  -ex "thread apply all bt full" \
                  -ex "quit" \
                  "$EXE" "$CORE_FILE" || echo "gdb core analysis failed"
              elif [ -n "$EXE" ]; then
                echo "Core not found; run once under gdb for live backtrace"
                $GDB_CMD --batch -q \
                  -ex "run" \
                  -ex "info threads" \
                  -ex "thread apply all bt full" \
                  -ex "quit" \
                  "$EXE" || true
              fi
              exit $EXIT_CODE
            fi

  openBSD_x86_64_test_Clang_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 14

  openBSD_x86_64_test_Clang_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 17

  openBSD_x86_64_test_Clang_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 20

  openBSD_x86_64_test_Clang_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 23

  openBSD_arm64_test_Clang_cpp11:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 11

  openBSD_arm64_test_Clang_cpp14:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 14

  openBSD_arm64_test_Clang_cpp17:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 17

  openBSD_arm64_test_Clang_cpp20:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 20

  openBSD_arm64_test_Clang_cpp23:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in OpenBSD
        id: OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          prepare: |
            pkg_add  cmake bash
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 23

  #Unix-NetBSD
  netBSD_x86_64_test_GCC_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_gcc.sh 11

  netBSD_x86_64_test_Clang_cpp11:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 11

  netBSD_x86_64_test_GCC_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_gcc.sh 14

  netBSD_x86_64_test_Clang_cpp14:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 14

  netBSD_x86_64_test_GCC_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_gcc.sh 17

  netBSD_x86_64_test_Clang_cpp17:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 17

  netBSD_x86_64_test_GCC_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_gcc.sh 20

  netBSD_x86_64_test_Clang_cpp20:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 20



  netBSD_x86_64_test_Clang_cpp23:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSD
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 23
  

  netBSD_arm64_test_GCC_cpp17:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSDArm64GCC
        uses: vmactions/netbsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_gcc.sh 17

  netBSD_arm64_test_Clang_cpp17:
    if: ${{ github.event.inputs.run_arm_tests == true || github.event.inputs.run_arm_tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run in NetBSD
        id: RunInNetBSDArm64Clang
        uses: vmactions/netbsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          mem: 8192
          release: "10.1"
          prepare: |
            set -e
            export PATH="/usr/sbin:/usr/bin:/usr/pkg/sbin:/usr/pkg/bin:$PATH"

            /usr/sbin/pkg_add -v pkgin || true
            pkgin -y update || true
            pkgin -y install cmake gmake bash gdb || true
            pkgin -y install clang || true
            pkgin -y install gcc12 || pkgin -y install gcc13 || pkgin -y install gcc10 || true
          run: |
            set -e -x
            cd build/test/unix_like  
            chmod +x *.sh
            ls -l
            ulimit -n
            ulimit -Hn
            ulimit -n 4096
            ./run_test_clang.sh 17

android_armv7_emulator_test:
  runs-on: macos-latest
  env:
    ANDROID_PLATFORM: "24"
    API_LEVEL: "30"
    BUILD_ABI: "armeabi-v7a"
    EMU_ARCH: "arm64-v8a"
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - id: setup-android
      uses: android-actions/setup-android@v3
    - id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r28c
        local-cache: false
    - name: Install SDK packages
      shell: bash
      run: |
        set -e
        sdkmanager --update
        sdkmanager --install "platform-tools" "emulator" "build-tools;35.0.0" "platforms;android-${API_LEVEL}" "system-images;android-${API_LEVEL};google_apis;${EMU_ARCH}"
        adb kill-server || true
    - name: Build Debug
      shell: bash
      run: |
        set -e
        NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
        mkdir -p build/test/android/${BUILD_ABI}/debug
        cd build/test/android/${BUILD_ABI}/debug
        cmake ../../../../../test \
          -G "Unix Makefiles" \
          -DANDROID_ABI=${BUILD_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DANDROID_NDK=${NDK} \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE=${NDK}/build/cmake/android.toolchain.cmake \
          -DTARGET_PLATFORM:STRING=android
        cmake --build . -- -j10
    - name: Build RelWithDebInfo
      shell: bash
      run: |
        set -e
        NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
        mkdir -p build/test/android/${BUILD_ABI}/relwithdebinfo
        cd build/test/android/${BUILD_ABI}/relwithdebinfo
        cmake ../../../../../test \
          -G "Unix Makefiles" \
          -DANDROID_ABI=${BUILD_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DANDROID_NDK=${NDK} \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_TOOLCHAIN_FILE=${NDK}/build/cmake/android.toolchain.cmake \
          -DTARGET_PLATFORM:STRING=android
        cmake --build . -- -j10
    - name: Locate artifacts
      shell: bash
      run: |
        set -e
        DBG="build/test/android/${BUILD_ABI}/debug/BqLogUnitTest"
        REL="build/test/android/${BUILD_ABI}/relwithdebinfo/BqLogUnitTest"
        [ -f "$DBG" ] || DBG="$(find build/test/android/${BUILD_ABI}/debug -type f -name BqLogUnitTest | head -n1)"
        [ -f "$REL" ] || REL="$(find build/test/android/${BUILD_ABI}/relwithdebinfo -type f -name BqLogUnitTest | head -n1)"
        echo "BIN_DBG=$DBG" >> $GITHUB_ENV
        echo "BIN_REL=$REL" >> $GITHUB_ENV
    - uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ env.API_LEVEL }}
        target: google_apis
        arch: ${{ env.EMU_ARCH }}
        force-avd-creation: true
        emulator-boot-timeout: 1200000
        disable-animations: false
        emulator-options: -no-snapshot -no-snapshot-save -wipe-data -no-boot-anim -noaudio -gpu swiftshader_indirect -qemu -accel tcg
        script: |
          set -e
          adb wait-for-device
          for i in $(seq 1 60); do
            v="$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')"
            [ "$v" = "1" ] && break
            sleep 5
          done
          for i in $(seq 1 5); do
            (adb shell settings put global window_animation_scale 0.0 && \
             adb shell settings put global transition_animation_scale 0.0 && \
             adb shell settings put global animator_duration_scale 0.0) && break || sleep 2
          done
          adb shell input keyevent 82 || true
          adb push "$BIN_DBG" /data/local/tmp/BqLogUnitTest_dbg
          adb shell chmod +x /data/local/tmp/BqLogUnitTest_dbg
          adb shell /data/local/tmp/BqLogUnitTest_dbg
          adb push "$BIN_REL" /data/local/tmp/BqLogUnitTest_rel
          adb shell chmod +x /data/local/tmp/BqLogUnitTest_rel
          adb shell /data/local/tmp/BqLogUnitTest_rel

android_arm64_emulator_test:
  runs-on: macos-latest
  env:
    ANDROID_PLATFORM: "24"
    API_LEVEL: "30"
    ANDROID_ABI: "arm64-v8a"
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - id: setup-android
      uses: android-actions/setup-android@v3
    - id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r28c
        local-cache: false
    - name: Install SDK packages
      shell: bash
      run: |
        set -e
        sdkmanager --update
        sdkmanager --install "platform-tools" "emulator" "build-tools;35.0.0" "platforms;android-${API_LEVEL}" "system-images;android-${API_LEVEL};google_apis;${ANDROID_ABI}"
        adb kill-server || true
    - name: Build Debug
      shell: bash
      run: |
        set -e
        NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
        mkdir -p build/test/android/${ANDROID_ABI}/debug
        cd build/test/android/${ANDROID_ABI}/debug
        cmake ../../../../../test \
          -G "Unix Makefiles" \
          -DANDROID_ABI=${ANDROID_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DANDROID_NDK=${NDK} \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE=${NDK}/build/cmake/android.toolchain.cmake \
          -DTARGET_PLATFORM:STRING=android
        cmake --build . -- -j10
    - name: Build RelWithDebInfo
      shell: bash
      run: |
        set -e
        NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
        mkdir -p build/test/android/${ANDROID_ABI}/relwithdebinfo
        cd build/test/android/${ANDROID_ABI}/relwithdebinfo
        cmake ../../../../../test \
          -G "Unix Makefiles" \
          -DANDROID_ABI=${ANDROID_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DANDROID_NDK=${NDK} \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_TOOLCHAIN_FILE=${NDK}/build/cmake/android.toolchain.cmake \
          -DTARGET_PLATFORM:STRING=android
        cmake --build . -- -j10
    - name: Locate artifacts
      shell: bash
      run: |
        set -e
        DBG="build/test/android/${ANDROID_ABI}/debug/BqLogUnitTest"
        REL="build/test/android/${ANDROID_ABI}/relwithdebinfo/BqLogUnitTest"
        [ -f "$DBG" ] || DBG="$(find build/test/android/${ANDROID_ABI}/debug -type f -name BqLogUnitTest | head -n1)"
        [ -f "$REL" ] || REL="$(find build/test/android/${ANDROID_ABI}/relwithdebinfo -type f -name BqLogUnitTest | head -n1)"
        echo "BIN_DBG=$DBG" >> $GITHUB_ENV
        echo "BIN_REL=$REL" >> $GITHUB_ENV
    - uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ env.API_LEVEL }}
        target: google_apis
        arch: ${{ env.ANDROID_ABI }}
        force-avd-creation: true
        emulator-boot-timeout: 1200000
        disable-animations: false
        emulator-options: -no-snapshot -no-snapshot-save -wipe-data -no-boot-anim -noaudio -gpu swiftshader_indirect -qemu -accel tcg
        script: |
          set -e
          adb wait-for-device
          for i in $(seq 1 60); do
            v="$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')"
            [ "$v" = "1" ] && break
            sleep 5
          done
          for i in $(seq 1 5); do
            (adb shell settings put global window_animation_scale 0.0 && \
             adb shell settings put global transition_animation_scale 0.0 && \
             adb shell settings put global animator_duration_scale 0.0) && break || sleep 2
          done
          adb shell input keyevent 82 || true
          adb push "$BIN_DBG" /data/local/tmp/BqLogUnitTest_dbg
          adb shell chmod +x /data/local/tmp/BqLogUnitTest_dbg
          adb shell /data/local/tmp/BqLogUnitTest_dbg
          adb push "$BIN_REL" /data/local/tmp/BqLogUnitTest_rel
          adb shell chmod +x /data/local/tmp/BqLogUnitTest_rel
          adb shell /data/local/tmp/BqLogUnitTest_rel

android_x86_emulator_test:
  runs-on: ubuntu-latest
  env:
    ANDROID_PLATFORM: "24"
    API_LEVEL: "30"
    ANDROID_ABI: "x86"
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - id: setup-android
      uses: android-actions/setup-android@v3
    - id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r28c
        local-cache: false
    - name: Install emulator dependencies
      shell: bash
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          libpulse0 libxkbfile1 libglib2.0-0 libnss3 libxshmfence1 libxcb1 libxcomposite1 \
          libxcursor1 libxdamage1 libxi6 libxtst6 libxrandr2 libxinerama1 libxxf86vm1 \
          libdbus-1-3 libfontconfig1 libasound2
    - name: Install SDK packages
      shell: bash
      run: |
        set -e
        sdkmanager --update
        sdkmanager --install "platform-tools" "emulator" "build-tools;35.0.0" "platforms;android-${API_LEVEL}" "system-images;android-${API_LEVEL};google_apis;${ANDROID_ABI}"
        adb kill-server || true
    - name: Build Debug
      shell: bash
      run: |
        set -e
        NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
        mkdir -p build/test/android/${ANDROID_ABI}/debug
        cd build/test/android/${ANDROID_ABI}/debug
        cmake ../../../../../test \
          -G "Unix Makefiles" \
          -DANDROID_ABI=${ANDROID_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DANDROID_NDK=${NDK} \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE=${NDK}/build/cmake/android.toolchain.cmake \
          -DTARGET_PLATFORM:STRING=android
        cmake --build . -- -j10
    - name: Build RelWithDebInfo
      shell: bash
      run: |
        set -e
        NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
        mkdir -p build/test/android/${ANDROID_ABI}/relwithdebinfo
        cd build/test/android/${ANDROID_ABI}/relwithdebinfo
        cmake ../../../../../test \
          -G "Unix Makefiles" \
          -DANDROID_ABI=${ANDROID_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DANDROID_NDK=${NDK} \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_TOOLCHAIN_FILE=${NDK}/build/cmake/android.toolchain.cmake \
          -DTARGET_PLATFORM:STRING=android
        cmake --build . -- -j10
    - name: Locate artifacts
      shell: bash
      run: |
        set -e
        DBG="build/test/android/${ANDROID_ABI}/debug/BqLogUnitTest"
        REL="build/test/android/${ANDROID_ABI}/relwithdebinfo/BqLogUnitTest"
        [ -f "$DBG" ] || DBG="$(find build/test/android/${ANDROID_ABI}/debug -type f -name BqLogUnitTest | head -n1)"
        [ -f "$REL" ] || REL="$(find build/test/android/${ANDROID_ABI}/relwithdebinfo -type f -name BqLogUnitTest | head -n1)"
        echo "BIN_DBG=$DBG" >> $GITHUB_ENV
        echo "BIN_REL=$REL" >> $GITHUB_ENV
    - uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ env.API_LEVEL }}
        target: google_apis
        arch: ${{ env.ANDROID_ABI }}
        force-avd-creation: true
        emulator-boot-timeout: 1200000
        disable-animations: false
        emulator-options: -no-snapshot -no-snapshot-save -wipe-data -no-boot-anim -noaudio -gpu swiftshader_indirect -accel off
        script: |
          set -e
          adb wait-for-device
          for i in $(seq 1 60); do
            v="$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')"
            [ "$v" = "1" ] && break
            sleep 5
          done
          for i in $(seq 1 5); do
            (adb shell settings put global window_animation_scale 0.0 && \
             adb shell settings put global transition_animation_scale 0.0 && \
             adb shell settings put global animator_duration_scale 0.0) && break || sleep 2
          done
          adb shell input keyevent 82 || true
          adb push "$BIN_DBG" /data/local/tmp/BqLogUnitTest_dbg
          adb shell chmod +x /data/local/tmp/BqLogUnitTest_dbg
          adb shell /data/local/tmp/BqLogUnitTest_dbg
          adb push "$BIN_REL" /data/local/tmp/BqLogUnitTest_rel
          adb shell chmod +x /data/local/tmp/BqLogUnitTest_rel
          adb shell /data/local/tmp/BqLogUnitTest_rel

android_x86_64_emulator_test:
  runs-on: ubuntu-latest
  env:
    ANDROID_PLATFORM: "24"
    API_LEVEL: "30"
    ANDROID_ABI: "x86_64"
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - id: setup-android
      uses: android-actions/setup-android@v3
    - id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r28c
        local-cache: false
    - name: Install emulator dependencies
      shell: bash
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          libpulse0 libxkbfile1 libglib2.0-0 libnss3 libxshmfence1 libxcb1 libxcomposite1 \
          libxcursor1 libxdamage1 libxi6 libxtst6 libxrandr2 libxinerama1 libxxf86vm1 \
          libdbus-1-3 libfontconfig1 libasound2
    - name: Install SDK packages
      shell: bash
      run: |
        set -e
        sdkmanager --update
        sdkmanager --install "platform-tools" "emulator" "build-tools;35.0.0" "platforms;android-${API_LEVEL}" "system-images;android-${API_LEVEL};google_apis;${ANDROID_ABI}"
        adb kill-server || true
    - name: Build Debug
      shell: bash
      run: |
        set -e
        NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
        mkdir -p build/test/android/${ANDROID_ABI}/debug
        cd build/test/android/${ANDROID_ABI}/debug
        cmake ../../../../../test \
          -G "Unix Makefiles" \
          -DANDROID_ABI=${ANDROID_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DANDROID_NDK=${NDK} \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE=${NDK}/build/cmake/android.toolchain.cmake \
          -DTARGET_PLATFORM:STRING=android
        cmake --build . -- -j10
    - name: Build RelWithDebInfo
      shell: bash
      run: |
        set -e
        NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
        mkdir -p build/test/android/${ANDROID_ABI}/relwithdebinfo
        cd build/test/android/${ANDROID_ABI}/relwithdebinfo
        cmake ../../../../../test \
          -G "Unix Makefiles" \
          -DANDROID_ABI=${ANDROID_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DANDROID_NDK=${NDK} \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_TOOLCHAIN_FILE=${NDK}/build/cmake/android.toolchain.cmake \
          -DTARGET_PLATFORM:STRING=android
        cmake --build . -- -j10
    - name: Locate artifacts
      shell: bash
      run: |
        set -e
        DBG="build/test/android/${ANDROID_ABI}/debug/BqLogUnitTest"
        REL="build/test/android/${ANDROID_ABI}/relwithdebinfo/BqLogUnitTest"
        [ -f "$DBG" ] || DBG="$(find build/test/android/${ANDROID_ABI}/debug -type f -name BqLogUnitTest | head -n1)"
        [ -f "$REL" ] || REL="$(find build/test/android/${ANDROID_ABI}/relwithdebinfo -type f -name BqLogUnitTest | head -n1)"
        echo "BIN_DBG=$DBG" >> $GITHUB_ENV
        echo "BIN_REL=$REL" >> $GITHUB_ENV
    - uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ env.API_LEVEL }}
        target: google_apis
        arch: ${{ env.ANDROID_ABI }}
        force-avd-creation: true
        emulator-boot-timeout: 1200000
        disable-animations: false
        emulator-options: -no-snapshot -no-snapshot-save -wipe-data -no-boot-anim -noaudio -gpu swiftshader_indirect -accel off
        script: |
          set -e
          adb wait-for-device
          for i in $(seq 1 60); do
            v="$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')"
            [ "$v" = "1" ] && break
            sleep 5
          done
          for i in $(seq 1 5); do
            (adb shell settings put global window_animation_scale 0.0 && \
             adb shell settings put global transition_animation_scale 0.0 && \
             adb shell settings put global animator_duration_scale 0.0) && break || sleep 2
          done
          adb shell input keyevent 82 || true
          adb push "$BIN_DBG" /data/local/tmp/BqLogUnitTest_dbg
          adb shell chmod +x /data/local/tmp/BqLogUnitTest_dbg
          adb shell /data/local/tmp/BqLogUnitTest_dbg
          adb push "$BIN_REL" /data/local/tmp/BqLogUnitTest_rel
          adb shell chmod +x /data/local/tmp/BqLogUnitTest_rel
          adb shell /data/local/tmp/BqLogUnitTest_rel
